{% extends "base.html" %}
{% load custom_filters %}
{% load static %}
{% block content %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
<div class="container mt-5">
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0 text-center flex-grow-1 font-weight-bold" id="liveToday" style="font-family: 'NanumSquareRoundB', sans-serif;"></h5>
            <a href="/manage">
                <img src="{% static 'img/calendar.png' %}" alt="Go to Calendar">
            </a>
        </div>
<div class="card-body" style="font-family: 'NanumSquareRoundB', sans-serif; text-align: center;">
{% for medication in medications %}
    <div class="medication">
        <h3>{{ medication.name }}</h3>
        <div class="dose_time">
            <button class="dose_taken" data-medication-id="{{ medication.id }}" data-dose-time="morning">
                {% if 'morning' in medicine_doses|get_item:medication.id %} 복용 완료{% else %} 아침 복용{% endif %}
            </button>
            <button class="dose_taken" data-medication-id="{{ medication.id }}" data-dose-time="afternoon">
                {% if 'afternoon' in medicine_doses|get_item:medication.id %} 복용 완료{% else %} 점심 복용{% endif %}
            </button>
            <button class="dose_taken" data-medication-id="{{ medication.id }}" data-dose-time="evening">
                {% if 'evening' in medicine_doses|get_item:medication.id %} 복용 완료{% else %} 저녁 복용{% endif %}
            </button>
        </div>
    </div>
{% endfor %}
</div>

    </div>
</div>
<style>
.mt-5 {
    margin-top: 3rem !important;
}
.transparent-btn {
    background-color: transparent;
    border: none;
}
</style>
<div class="container" style="margin-top: 80px;">
    <div class="d-flex justify-content-center flex-wrap">
        <div class="p-2">
            <button type="button" id="search" class="btn btn-secondary transparent-btn" onclick="location.href='/search';">
                <img src="{% static 'img/search.png' %}" alt="Search">
            </button>
            <span class="d-block text-center" style="font-family: 'NanumSquareRoundB', sans-serif;">약품 검색</span>
        </div>
        <div class="p-2">
            <button type="button" id="manage" class="btn btn-secondary transparent-btn" onclick="location.href='/manage';">
                <img src="{% static 'img/edit.png' %}" alt="manage">
            </button>
            <span class="d-block text-center" style="font-family: 'NanumSquareRoundB', sans-serif;">약품 관리</span>
        </div>
        <div class="p-2">
            <button type="button" id="community" class="btn btn-secondary transparent-btn" onclick="location.href='/forum';">
                <img src="{% static 'img/board.png' %}" alt="board">
            </button>
            <span class="d-block text-center" style="font-family: 'NanumSquareRoundB', sans-serif;">커뮤니티</span>
        </div>
    </div>
</div>
{% if alert %}
<script>
Swal.fire({
  title: '변경 성공!!',
  text: '{{ alert }}',
  icon: 'success',
  confirmButtonText: '확인'
});
</script>
{% endif %}

<script>
    var today = new Date();
    var dd = String(today.getDate()).padStart(2, '0');
    var mm = String(today.getMonth() + 1).padStart(2, '0');
    var currentDate = mm + '/' + dd;
    document.getElementById('liveToday').innerHTML = currentDate;
</script>

<script>
$(document).ready(function() {
    $('.dose_taken').click(function() {
        var medicationId = $(this).data('medication-id');
        var doseTime = $(this).data('dose-time');
        $.ajax({
            url: '/save_medication/' + medicationId + '/',
            type: 'POST',
            data: {
                'dose_time': doseTime,
                'dose_taken': true,
            },
            success: function() {
                alert('복용 정보가 업데이트되었습니다.');
                location.reload();
            },
            error: function() {
                alert('복용 정보 업데이트에 실패했습니다.');
            },
        });
    });
});
</script>

{% endblock %}
